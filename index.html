<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>My GitHub Gantt Chart</title>
    <style>
        #gantt {
            max-width: 800px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });

        import { Octokit, App } from "https://esm.sh/octokit";
        const token = '';
        const username = "jaketbailey";
        const repo = "final-year-project";

        const octokit = new Octokit({ auth: token });

        const {
            data: { login },
        } = await octokit.rest.users.getAuthenticated();
        console.log("Hello, %s", login);

        const { data: repos } = await octokit.rest.repos.listForAuthenticatedUser();
        console.log(repos);

        const prs = await octokit.rest.search.issuesAndPullRequests({
            q: `type:pr+repo:${username}/${repo}+created:>=2022-01-01`,
            per_page: 100,
        });

        const branchArr = ["main"];
        let branchCheck = false;

        let mermaidCommit = ``;
        mermaidCommit += `---\n`;
        mermaidCommit += `title: "@jaketbailey/final-year-project"\n`;
        mermaidCommit += `---\n`;
        mermaidCommit += `gitGraph\n`;
        mermaidCommit += `  commit id: "Initial commit"\n`;
        let previousBase = "";

        //for const wuith index
        
        let i = 0;
        const len = prs.data.items.length;

        for (const pr of prs.data.items.reverse()) {
            console.log(`Processing PR ${i + 1} of ${len}`)
            // get pr branch
            const { data: prBranch } = await octokit.rest.pulls.get({
                owner: username,
                repo: repo,
                pull_number: pr.number,
            });

            branchCheck = branchArr.includes(prBranch.base.ref);

            if (i === 0) {
                mermaidCommit += `  branch ${prBranch.base.ref}\n`
                mermaidCommit += `  checkout ${prBranch.base.ref}\n`;
            } else {
                if (prBranch.base.ref !== previousBase) {
                    if (prBranch.base.ref !== "main") {
                        if (!mermaidCommit.includes(`branch ${prBranch.base.ref}`)) {
                            mermaidCommit += `  branch ${prBranch.base.ref}\n`
                        }
                        branchArr.push(prBranch.base.ref);
                        mermaidCommit += `  checkout ${prBranch.base.ref}\n`;
                    } else {
                        mermaidCommit += `  checkout main\n`;
                        mermaidCommit += `  merge ${previousBase}\n`;
                    }
                }
            }
            
            // console.log(pr)
            previousBase = prBranch.base.ref;
            mermaidCommit += `  commit id: "${pr.title}"\n`;
            i++;
        }

        const gitGraph = document.createElement("pre");
        gitGraph.textContent = mermaidCommit;
        gitGraph.classList.add("mermaid");
        document.body.appendChild(gitGraph);

        await mermaid.run({ nodes: document.querySelectorAll(".mermaid") });

    </script>

    <button id="download" >Download</button>


    <pre id="gantt" class="mermaid"">
        gantt
        dateFormat  YYYY-MM-DD
        title       Adding GANTT diagram functionality to mermaid
        excludes    weekends
        %% (`excludes` accepts specific dates in YYYY-MM-DD format, days of the week ("sunday") or "weekends", but not the word "weekdays".)

        section A section
        Completed task            :done,    des1, 2014-01-06,2014-01-08
        Active task               :active,  des2, 2014-01-09, 3d
        Future task               :         des3, after des2, 5d
        Future task2              :         des4, after des3, 5d

        section Critical tasks
        Completed task in the critical line :crit, done, 2014-01-06,24h
        Implement parser and jison          :crit, done, after des1, 2d
        Create tests for parser             :crit, active, 3d
        Future task in critical line        :crit, 5d
        Create tests for renderer           :2d
        Add to mermaid                      :1d
        Functionality added                 :milestone, 2014-01-25, 0d

        section Documentation
        Describe gantt syntax               :active, a1, after des1, 3d
        Add gantt diagram to demo page      :after a1  , 20h
        Add another diagram to demo page    :doc1, after a1  , 48h

        section Last section
        Describe gantt syntax               :after doc1, 3d
        Add gantt diagram to demo page      :20h
        Add another diagram to demo page    :48h
    </pre>
</body>
</html>
